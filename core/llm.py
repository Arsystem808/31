# core/llm.py
def build_rationale(symbol: str, horizon_ui: str, sig: dict, detail: str = "Стандарт") -> str:
    """
    Офлайн-генерация текста по сигналу.
    Без GPT — чисто Python, но со стилистикой "живого" анализа.
    """

    action_map = {
        "BUY": "Покупка",
        "SHORT": "Шорт (игра на понижение)",
        "CLOSE": "Закрыть позицию",
        "WAIT": "Наблюдать (пауза)"
    }

    action = action_map.get(sig.get("action", ""), sig.get("action", ""))

    # Определяем длину текста в зависимости от детализации
    if detail == "Коротко":
        sentences_target = 3
    elif detail == "Подробно":
        sentences_target = 8
    else:
        sentences_target = 5

    # Вводная часть
    intro = f"По тикеру {symbol} на горизонте «{horizon_ui}» вижу сигнал: {action.lower()}."
    price_zone = (
        f" Вход предполагается от уровня {sig['entry']:.2f}, "
        f"цели — {sig['tp1']:.2f} и {sig['tp2']:.2f}, "
        f"стоп — {sig['sl']:.2f}."
    )

    # Контекст уровней
    pivot_info = []
    if sig.get("R1") and sig.get("S1"):
        pivot_info.append(
            f"Сейчас цена находится ближе к {'сопротивлению' if sig['entry'] < sig['R1'] else 'поддержке'}. "
            f"Ключевые пивот-уровни: R1={sig['R1']:.2f}, R2={sig['R2']:.2f}, R3={sig['R3']:.2f}, "
            f"S1={sig['S1']:.2f}, S2={sig['S2']:.2f}, S3={sig['S3']:.2f}."
        )

    # Логика в стиле «интуиции»
    logic = []
    if sig["action"] == "BUY":
        logic.append("Рынок демонстрирует признаки удержания ключевых поддержек и формирования восходящего импульса.")
        logic.append("Если покупатели смогут закрепиться выше ближайшего сопротивления, есть шанс на ускорение роста.")
    elif sig["action"] == "SHORT":
        logic.append("Вижу признаки выдыхания роста и возможного разворота вниз.")
        logic.append("Закрепление ниже ключевых уровней может открыть дорогу к снижению.")
    elif sig["action"] == "WAIT":
        logic.append("Ситуация неоднозначная: лучше дождаться подтверждения направления.")
    elif sig["action"] == "CLOSE":
        logic.append("Движение достигло целевых уровней или теряет импульс — разумно зафиксировать результат.")

    # Дополнительные наблюдения
    extra = []
    if horizon_ui == "Краткосрок":
        extra.append("Для краткосрочной сделки важно следить за реакцией на ближайшие уровни в течение 1–3 дней.")
    elif horizon_ui == "Среднесрок":
        extra.append("В среднесрочной перспективе ключевым будет пробой или отскок от зон R1/S1.")
    elif horizon_ui == "Долгосрок":
        extra.append("В долгосрочном плане важна общая структура тренда и удержание глобальных зон поддержки.")

    # Собираем текст
    parts = [intro, price_zone] + pivot_info + logic + extra
    text = " ".join(parts)

    # Если текста мало — слегка расширяем деталями
    if len(parts) < sentences_target:
        text += " " + " ".join([
            "Объём сделок и поведение цены около уровней дадут дополнительные подсказки.",
            "Стоит учитывать новости и общий фон рынка, чтобы подтвердить сигнал.",
            "Мой взгляд остаётся гибким: готов скорректировать позицию при изменении динамики."
        ][:max(0, sentences_target - len(parts))])

    return text
